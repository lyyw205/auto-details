<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>위젯 갤러리</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg-0: #0a0a0a;
    --bg-1: #111111;
    --bg-2: #1a1a1a;
    --bg-3: #222222;
    --border: #2a2a2a;
    --border-hover: #444;
    --text-1: #f0f0f0;
    --text-2: #aaa;
    --text-3: #666;
    --accent: #7c6ff7;
    --accent-dim: rgba(124,111,247,0.15);
    --danger: #e74c3c;
    --danger-dim: rgba(231,76,60,0.15);
    --sidebar-w: 240px;
    --toolbar-h: 56px;
  }

  body {
    font-family: 'Inter', 'Noto Sans KR', system-ui, sans-serif;
    background: var(--bg-0);
    color: var(--text-1);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ── Toolbar ── */
  .toolbar {
    height: var(--toolbar-h);
    background: var(--bg-1);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 16px;
    flex-shrink: 0;
    z-index: 10;
  }
  .toolbar-title {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.02em;
    white-space: nowrap;
  }
  .toolbar-spacer { flex: 1; }
  .toolbar select {
    background: var(--bg-2);
    color: var(--text-1);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    outline: none;
  }
  .toolbar select:hover { border-color: var(--border-hover); }
  .toolbar select:focus { border-color: var(--accent); }
  .view-toggle, .mode-toggle {
    display: flex;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .view-toggle button, .mode-toggle button {
    background: none;
    border: none;
    color: var(--text-3);
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
    font-family: inherit;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .view-toggle button.active, .mode-toggle button.active {
    background: var(--accent-dim);
    color: var(--accent);
  }
  .view-toggle button:hover:not(.active), .mode-toggle button:hover:not(.active) { color: var(--text-2); }
  .filter-count {
    font-size: 12px;
    color: var(--text-3);
    white-space: nowrap;
  }

  /* ── Layout ── */
  .layout {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ── Sidebar ── */
  .sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--bg-1);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .sidebar-item {
    padding: 8px 16px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.1s;
    user-select: none;
  }
  .sidebar-item:hover { background: var(--bg-2); }
  .sidebar-item.active { background: var(--accent-dim); color: var(--accent); }
  .sidebar-item.all-view {
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    padding: 12px 16px;
  }

  .category-header {
    padding: 10px 16px 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-3);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .category-header:hover { color: var(--text-2); }
  .category-header .arrow {
    font-size: 9px;
    transition: transform 0.15s;
  }
  .category-header.collapsed .arrow { transform: rotate(-90deg); }
  .category-header .cat-count {
    margin-left: auto;
    font-size: 10px;
    color: var(--text-3);
    font-weight: 500;
  }

  .section-item {
    padding: 6px 16px 6px 28px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.1s;
    user-select: none;
  }
  .section-item:hover { background: var(--bg-2); }
  .section-item.active { background: var(--accent-dim); color: var(--accent); }
  .section-item.empty {
    color: var(--text-3);
    cursor: default;
    opacity: 0.5;
  }
  .section-item.empty:hover { background: transparent; }
  .section-item .badge {
    margin-left: auto;
    background: var(--bg-3);
    color: var(--text-3);
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 8px;
    min-width: 18px;
    text-align: center;
  }
  .section-item.active .badge {
    background: var(--accent-dim);
    color: var(--accent);
  }

  .sidebar-footer {
    margin-top: auto;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-3);
    line-height: 1.6;
  }

  /* ── Main ── */
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .main::-webkit-scrollbar { width: 6px; }
  .main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ── Grid view ── */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(327px, 1fr));
    gap: 16px;
  }

  /* ── List view ── */
  .grid.list-view {
    grid-template-columns: 1fr;
  }
  .grid.list-view .card {
    display: flex;
    flex-direction: row;
    gap: 16px;
  }
  .grid.list-view .card-preview { flex-shrink: 0; }
  .grid.list-view .card-meta {
    flex: 1;
    border-top: none;
    padding-top: 12px;
  }

  /* ── Card ── */
  .card {
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .card:hover {
    border-color: var(--border-hover);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .card-preview {
    width: 100%;
    height: 400px;
    overflow: hidden;
    position: relative;
    background: var(--bg-3);
  }
  .card-preview iframe {
    width: 860px;
    border: none;
    pointer-events: none;
    transform-origin: top center;
    margin-left: calc(50% - 430px);
  }

  .card-meta {
    padding: 12px 14px;
    border-top: 1px solid var(--border);
  }
  .card-id {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 12px;
    color: var(--text-2);
    margin-bottom: 8px;
    word-break: break-all;
  }
  .card-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 6px;
  }
  .badge-pill {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 4px;
    font-weight: 600;
    letter-spacing: 0.02em;
  }
  .badge-composition {
    background: rgba(59,130,246,0.15);
    color: #60a5fa;
  }
  .badge-theme-dark {
    background: rgba(255,255,255,0.08);
    color: #ccc;
  }
  .badge-theme-light {
    background: rgba(255,220,100,0.15);
    color: #e0c050;
  }
  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 4px;
  }
  .tag-chip {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 3px;
    background: var(--bg-3);
    color: var(--text-3);
  }
  .card-source {
    font-size: 10px;
    color: var(--text-3);
  }

  /* ── Empty state ── */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: var(--text-3);
    font-size: 14px;
    gap: 8px;
  }

  /* ── Modal ── */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 100;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding: 40px 20px;
    overflow: hidden;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 85vw;
    height: 85vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .modal-title {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 14px;
    color: var(--text-2);
  }
  .modal-close {
    background: none;
    border: none;
    color: var(--text-3);
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .modal-close:hover { background: var(--bg-2); color: var(--text-1); }

  .modal-body {
    display: flex;
    gap: 0;
    flex: 1;
    min-height: 0;
  }
  .modal-preview {
    flex: 1;
    min-width: 0;
    background: var(--bg-0);
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
  }
  .modal-preview::-webkit-scrollbar { width: 6px; }
  .modal-preview::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .modal-preview iframe {
    width: 860px;
    border: none;
    display: block;
    transform: scale(0.5);
    transform-origin: top center;
    margin-left: calc(50% - 430px);
  }
  .modal-info {
    width: 280px;
    min-width: 280px;
    border-left: 1px solid var(--border);
    padding: 16px;
    overflow-y: auto;
  }
  .modal-info h4 {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-3);
    margin: 12px 0 6px;
  }
  .modal-info h4:first-child { margin-top: 0; }
  .modal-info p, .modal-info .meta-val {
    font-size: 13px;
    color: var(--text-2);
    word-break: break-all;
    line-height: 1.5;
  }
  .modal-info .meta-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  /* ── Modal action buttons ── */
  .modal-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .btn-action {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--bg-2);
    color: var(--text-2);
    transition: all 0.15s;
  }
  .btn-action:hover {
    border-color: var(--border-hover);
    color: var(--text-1);
  }
  .btn-action.copied {
    border-color: #4ade80;
    color: #4ade80;
  }
  .btn-delete {
    border-color: rgba(231,76,60,0.3);
    color: var(--danger);
    background: var(--danger-dim);
  }
  .btn-delete:hover {
    border-color: var(--danger);
    background: rgba(231,76,60,0.25);
    color: #ff6b5e;
  }

  /* ── File path display ── */
  .file-path-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .file-path-row .meta-val {
    flex: 1;
    min-width: 0;
  }
  .btn-copy-sm {
    flex-shrink: 0;
    background: none;
    border: none;
    color: var(--text-3);
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 14px;
    line-height: 1;
  }
  .btn-copy-sm:hover { color: var(--text-1); background: var(--bg-3); }
  .btn-copy-sm.copied { color: #4ade80; }

  /* ── Confirm dialog ── */
  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .confirm-overlay.open { display: flex; }
  .confirm-dialog {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    text-align: center;
  }
  .confirm-dialog h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .confirm-dialog p {
    font-size: 13px;
    color: var(--text-2);
    margin-bottom: 20px;
    line-height: 1.5;
    word-break: break-all;
  }
  .confirm-dialog .confirm-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
  }
  .confirm-dialog button {
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: all 0.15s;
  }
  .confirm-dialog .btn-cancel {
    background: var(--bg-2);
    color: var(--text-2);
  }
  .confirm-dialog .btn-cancel:hover {
    background: var(--bg-3);
    color: var(--text-1);
  }
  .confirm-dialog .btn-confirm-delete {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }
  .confirm-dialog .btn-confirm-delete:hover {
    background: #c0392b;
  }

  /* ── NEW badge (sidebar + cards) ── */
  .sidebar-item.new-tab {
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    padding: 12px 16px;
  }
  .new-count-badge {
    margin-left: auto;
    background: #e74c3c;
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 8px;
    min-width: 18px;
    text-align: center;
  }
  .badge-new {
    background: rgba(231,76,60,0.2);
    color: #e74c3c;
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 3px;
    font-weight: 700;
    letter-spacing: 0.04em;
  }

  /* ── Bulk review toolbar ── */
  .bulk-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
  }
  .bulk-toolbar-text {
    font-size: 13px;
    color: var(--text-2);
  }
  .btn-bulk {
    padding: 7px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--accent);
    background: var(--accent-dim);
    color: var(--accent);
    transition: all 0.15s;
  }
  .btn-bulk:hover {
    background: rgba(124,111,247,0.3);
  }

  /* ── New widget card actions ── */
  .card-actions {
    display: flex;
    gap: 6px;
    margin-top: 8px;
  }
  .card-actions button {
    flex: 1;
    padding: 6px 0;
    border-radius: 5px;
    font-size: 11px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: all 0.15s;
  }
  .btn-review {
    background: var(--accent-dim);
    color: var(--accent);
    border-color: rgba(124,111,247,0.3);
  }
  .btn-review:hover {
    background: rgba(124,111,247,0.3);
    border-color: var(--accent);
  }
  .btn-card-delete {
    background: var(--danger-dim);
    color: var(--danger);
    border-color: rgba(231,76,60,0.3);
  }
  .btn-card-delete:hover {
    background: rgba(231,76,60,0.25);
    border-color: var(--danger);
  }

  /* ── Duplicate comparison card ── */
  .dup-card {
    grid-column: 1 / -1;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .dup-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(231,76,60,0.06);
  }
  .dup-card-header-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-2);
  }
  .dup-similarity {
    font-size: 12px;
    font-weight: 700;
    color: var(--danger);
    background: var(--danger-dim);
    padding: 2px 8px;
    border-radius: 4px;
  }
  .dup-card-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
  }
  .dup-side {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .dup-side:first-child {
    border-right: 1px solid var(--border);
  }
  .dup-side-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-3);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .dup-preview {
    width: 100%;
    height: 350px;
    overflow: hidden;
    position: relative;
    background: var(--bg-3);
    border-radius: 6px;
  }
  .dup-preview iframe {
    width: 860px;
    border: none;
    pointer-events: none;
    transform-origin: top center;
    margin-left: calc(50% - 430px);
  }
  .dup-meta {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 11px;
    color: var(--text-2);
    word-break: break-all;
  }
  .btn-keep {
    padding: 7px 0;
    border-radius: 5px;
    font-size: 11px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid rgba(74,222,128,0.3);
    background: rgba(74,222,128,0.1);
    color: #4ade80;
    transition: all 0.15s;
    width: 100%;
  }
  .btn-keep:hover {
    background: rgba(74,222,128,0.2);
    border-color: #4ade80;
  }

  /* ── Unmapped sections ── */
  .sidebar-item.unmapped-tab {
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    padding: 12px 16px;
  }
  .unmapped-count-badge {
    margin-left: auto;
    background: #e67e22;
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 8px;
    min-width: 18px;
    text-align: center;
  }

  .unmapped-card {
    grid-column: 1 / -1;
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .unmapped-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(230,126,34,0.06);
  }
  .unmapped-card-header-id {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-1);
  }
  .unmapped-confidence {
    font-size: 12px;
    font-weight: 700;
    color: #e67e22;
    background: rgba(230,126,34,0.15);
    padding: 2px 8px;
    border-radius: 4px;
  }
  .unmapped-card-body {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .unmapped-row {
    display: flex;
    gap: 8px;
    font-size: 13px;
  }
  .unmapped-label {
    color: var(--text-3);
    min-width: 70px;
    flex-shrink: 0;
    font-weight: 500;
  }
  .unmapped-value {
    color: var(--text-2);
    line-height: 1.5;
  }
  .unmapped-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .unmapped-tag {
    font-size: 11px;
    padding: 2px 7px;
    border-radius: 4px;
    background: var(--bg-3);
    color: var(--text-3);
  }
  .unmapped-card-actions {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
  }
  .btn-approve {
    flex: 1;
    padding: 8px 0;
    border-radius: 6px;
    font-size: 12px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid rgba(74,222,128,0.3);
    background: rgba(74,222,128,0.1);
    color: #4ade80;
    transition: all 0.15s;
  }
  .btn-approve:hover {
    background: rgba(74,222,128,0.2);
    border-color: #4ade80;
  }
  .btn-reassign {
    flex: 1;
    padding: 8px 0;
    border-radius: 6px;
    font-size: 12px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid rgba(230,126,34,0.3);
    background: rgba(230,126,34,0.1);
    color: #e67e22;
    transition: all 0.15s;
  }
  .btn-reassign:hover {
    background: rgba(230,126,34,0.2);
    border-color: #e67e22;
  }

  /* ── Reassign modal ── */
  .reassign-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .reassign-overlay.open { display: flex; }
  .reassign-dialog {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: 12px;
    max-width: 480px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }
  .reassign-dialog-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .reassign-dialog-header h3 {
    font-size: 15px;
    font-weight: 700;
  }
  .reassign-dialog-header .modal-close {
    background: none;
    border: none;
    color: var(--text-3);
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .reassign-dialog-header .modal-close:hover { background: var(--bg-2); color: var(--text-1); }
  .reassign-dialog-desc {
    padding: 12px 20px;
    font-size: 13px;
    color: var(--text-2);
    border-bottom: 1px solid var(--border);
  }
  .reassign-dialog-body {
    padding: 12px 20px;
    overflow-y: auto;
    flex: 1;
  }
  .reassign-cat-header {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-3);
    padding: 10px 0 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .reassign-cat-header .recommended {
    font-size: 10px;
    color: #e67e22;
    font-weight: 600;
    letter-spacing: 0;
    text-transform: none;
  }
  .reassign-options {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding-bottom: 8px;
  }
  .reassign-option {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: var(--bg-2);
    color: var(--text-2);
    transition: all 0.15s;
  }
  .reassign-option:hover {
    border-color: var(--border-hover);
    color: var(--text-1);
  }
  .reassign-option.selected {
    border-color: var(--accent);
    background: var(--accent-dim);
    color: var(--accent);
  }
  .reassign-option input[type="radio"] { display: none; }
  .reassign-dialog-footer {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    padding: 12px 20px;
    border-top: 1px solid var(--border);
  }
  .reassign-dialog-footer button {
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: all 0.15s;
  }
  .reassign-btn-cancel {
    background: var(--bg-2);
    color: var(--text-2);
  }
  .reassign-btn-cancel:hover { background: var(--bg-3); color: var(--text-1); }
  .reassign-btn-submit {
    background: var(--accent-dim);
    color: var(--accent);
    border-color: rgba(124,111,247,0.3);
  }
  .reassign-btn-submit:hover { background: rgba(124,111,247,0.3); border-color: var(--accent); }
  .reassign-btn-submit:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ── Dup Compare Modal ── */
  .dup-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 100;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 30px 20px;
    overflow: hidden;
  }
  .dup-modal-overlay.open { display: flex; }
  .dup-modal {
    background: var(--bg-1);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 85vw;
    height: 85vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
  }
  .dup-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    background: rgba(231,76,60,0.06);
  }
  .dup-modal-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .dup-modal-header h3 { font-size: 15px; font-weight: 700; }
  .dup-modal-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
  }
  .dup-modal-body::-webkit-scrollbar { width: 6px; }
  .dup-modal-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .dup-modal-side {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 16px;
  }
  .dup-modal-side:first-child {
    border-right: 1px solid var(--border);
  }
  .dup-modal-side-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-3);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .dup-modal-preview {
    width: 100%;
    overflow: hidden;
    position: relative;
    background: var(--bg-3);
    border-radius: 8px;
  }
  .dup-modal-preview iframe {
    width: 860px;
    border: none;
    pointer-events: none;
    transform-origin: top center;
    margin-left: calc(50% - 430px);
  }
  .dup-modal-meta {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 12px;
    color: var(--text-2);
    word-break: break-all;
  }
  .dup-modal-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .dup-modal-actions {
    display: flex;
    gap: 8px;
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .dup-modal-actions button {
    flex: 1;
    min-width: 120px;
    padding: 9px 0;
    border-radius: 6px;
    font-size: 12px;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-keep-one {
    border: 1px solid rgba(74,222,128,0.3);
    background: rgba(74,222,128,0.1);
    color: #4ade80;
  }
  .btn-keep-one:hover {
    background: rgba(74,222,128,0.2);
    border-color: #4ade80;
  }
  .btn-keep-both {
    border: 1px solid rgba(124,111,247,0.3);
    background: rgba(124,111,247,0.1);
    color: var(--accent);
  }
  .btn-keep-both:hover {
    background: rgba(124,111,247,0.25);
    border-color: var(--accent);
  }
  .btn-delete-both {
    border: 1px solid rgba(231,76,60,0.3);
    background: rgba(231,76,60,0.1);
    color: var(--danger);
  }
  .btn-delete-both:hover {
    background: rgba(231,76,60,0.25);
    border-color: var(--danger);
  }
</style>
</head>
<body>

<!-- Toolbar -->
<div class="toolbar">
  <div class="toolbar-title">위젯 갤러리</div>
  <div class="toolbar-spacer"></div>
  <div class="mode-toggle">
    <button id="btnDemo" class="active">Demo</button>
    <button id="btnRaw">Raw</button>
  </div>
  <select id="refSelect">
    <option value="">레퍼런스: 전체</option>
  </select>
  <div class="view-toggle">
    <button id="btnGrid" class="active" title="그리드">&#9638;</button>
    <button id="btnList" title="리스트">&#9776;</button>
  </div>
  <span class="filter-count" id="filterCount"></span>
</div>

<!-- Layout -->
<div class="layout">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar"></div>

  <!-- Main -->
  <div class="main" id="main">
    <div class="grid" id="grid"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle"></span>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-preview" id="modalPreview"></div>
      <div class="modal-info" id="modalInfo"></div>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-dialog">
    <h3>위젯 삭제</h3>
    <p id="confirmMessage"></p>
    <div class="confirm-buttons">
      <button class="btn-cancel" id="confirmCancel">취소</button>
      <button class="btn-confirm-delete" id="confirmDelete">삭제</button>
    </div>
  </div>
</div>

<!-- Dup Compare Modal -->
<div class="dup-modal-overlay" id="dupModalOverlay">
  <div class="dup-modal">
    <div class="dup-modal-header">
      <div class="dup-modal-header-left">
        <h3>중복 위젯 비교</h3>
        <span class="dup-similarity" id="dupModalScore"></span>
      </div>
      <button class="modal-close" id="dupModalClose">&times;</button>
    </div>
    <div class="dup-modal-body" id="dupModalBody"></div>
    <div class="dup-modal-actions" id="dupModalActions"></div>
  </div>
</div>

<!-- Reassign Modal -->
<div class="reassign-overlay" id="reassignOverlay">
  <div class="reassign-dialog">
    <div class="reassign-dialog-header">
      <h3>기존 섹션에 배정</h3>
      <button class="modal-close" id="reassignClose">&times;</button>
    </div>
    <div class="reassign-dialog-desc" id="reassignDesc"></div>
    <div class="reassign-dialog-body" id="reassignBody"></div>
    <div class="reassign-dialog-footer">
      <button class="reassign-btn-cancel" id="reassignCancel">취소</button>
      <button class="reassign-btn-submit" id="reassignSubmit" disabled>배정</button>
    </div>
  </div>
</div>

<script>
(function() {
  // ── State ──
  let registry = null;
  let presets = [];
  let taxonomy = null;
  let allWidgets = []; // flat list
  let newWidgets = []; // widgets with status:"new"
  let unmappedSections = []; // pending unmapped sections
  let currentFilter = null; // null = all, '__new__' = new widgets, '__unmapped__' = unmapped, string = taxonomy_id
  let currentRef = null; // null = all, string = source_ref
  let viewMode = 'grid';
  let previewMode = 'demo'; // 'demo' or 'raw'

  const CATEGORY_ORDER = ['intro', 'problem', 'features', 'trust', 'conversion'];

  // ── Data fetching ──
  async function fetchAll() {
    const [reg, pre, tax, nw, um] = await Promise.all([
      fetch('/api/registry').then(r => r.json()),
      fetch('/api/presets').then(r => r.json()),
      fetch('/api/taxonomy').then(r => r.json()),
      fetch('/api/widgets/new').then(r => r.json()),
      fetch('/api/unmapped').then(r => r.json()),
    ]);
    registry = reg;
    presets = pre;
    taxonomy = tax;
    newWidgets = nw.widgets || [];
    unmappedSections = um.sections || [];
    rebuildWidgetList();
  }

  function rebuildWidgetList() {
    allWidgets = [];
    for (const [taxonomyId, widgets] of Object.entries(registry.widgets)) {
      const section = taxonomy.sections.find(s => s.id === taxonomyId);
      const category = section ? section.category : '_custom';
      for (const w of widgets) {
        allWidgets.push({ ...w, taxonomy_id: taxonomyId, category });
      }
    }
  }

  // ── Sidebar ──
  function buildSidebar() {
    const sb = document.getElementById('sidebar');

    // Count widgets per taxonomy
    const countMap = {};
    for (const w of allWidgets) countMap[w.taxonomy_id] = (countMap[w.taxonomy_id] || 0) + 1;

    // "All"
    let html = `<div class="sidebar-item all-view${currentFilter === null ? ' active' : ''}" data-filter="">All</div>`;

    // "New" tab
    const newCount = newWidgets.length;
    if (newCount > 0) {
      html += `<div class="sidebar-item new-tab${currentFilter === '__new__' ? ' active' : ''}" data-filter="__new__">New <span class="new-count-badge">${newCount}</span></div>`;
    }

    // "Unmapped" tab
    const unmappedCount = unmappedSections.length;
    if (unmappedCount > 0) {
      html += `<div class="sidebar-item unmapped-tab${currentFilter === '__unmapped__' ? ' active' : ''}" data-filter="__unmapped__">Unmapped <span class="unmapped-count-badge">${unmappedCount}</span></div>`;
    }

    // Categories
    for (const catId of CATEGORY_ORDER) {
      const cat = taxonomy.categories[catId];
      const sections = taxonomy.sections.filter(s => s.category === catId);
      const catCount = sections.reduce((sum, s) => sum + (countMap[s.id] || 0), 0);

      html += `<div class="category-header" data-cat="${catId}">
        <span class="arrow">&#9660;</span> ${catId} <span class="cat-count">${catCount}</span>
      </div>`;
      html += `<div class="category-sections" data-cat="${catId}">`;
      for (const s of sections) {
        const c = countMap[s.id] || 0;
        const isEmpty = c === 0;
        const isActive = currentFilter === s.id;
        html += `<div class="section-item${isEmpty ? ' empty' : ''}${isActive ? ' active' : ''}" data-filter="${s.id}" ${isEmpty ? '' : ''}>
          ${s.id} <span class="badge">${c}</span>
        </div>`;
      }
      html += `</div>`;
    }

    // Footer
    const totalSections = taxonomy.sections.length;
    const filledSections = new Set(allWidgets.map(w => w.taxonomy_id)).size;
    html += `<div class="sidebar-footer">${allWidgets.length} widgets &middot; ${presets.length} presets &middot; ${filledSections}/${totalSections} sections</div>`;

    sb.innerHTML = html;

    // Events
    sb.querySelector('.all-view').addEventListener('click', () => { currentFilter = null; render(); });

    const newTab = sb.querySelector('.new-tab');
    if (newTab) {
      newTab.addEventListener('click', () => { currentFilter = '__new__'; render(); });
    }

    const unmappedTab = sb.querySelector('.unmapped-tab');
    if (unmappedTab) {
      unmappedTab.addEventListener('click', () => { currentFilter = '__unmapped__'; render(); });
    }

    sb.querySelectorAll('.category-header').forEach(el => {
      el.addEventListener('click', () => {
        el.classList.toggle('collapsed');
        const sec = sb.querySelector(`.category-sections[data-cat="${el.dataset.cat}"]`);
        sec.style.display = el.classList.contains('collapsed') ? 'none' : '';
      });
    });

    sb.querySelectorAll('.section-item:not(.empty)').forEach(el => {
      el.addEventListener('click', () => {
        currentFilter = el.dataset.filter;
        render();
      });
    });
  }

  // ── Reference select ──
  function buildRefSelect() {
    const sel = document.getElementById('refSelect');
    const refs = [...new Set(allWidgets.map(w => w.source_ref).filter(Boolean))].sort();
    for (const ref of refs) {
      const count = allWidgets.filter(w => w.source_ref === ref).length;
      const opt = document.createElement('option');
      opt.value = ref;
      opt.textContent = `${ref} (${count})`;
      sel.appendChild(opt);
    }
    sel.addEventListener('change', () => {
      currentRef = sel.value || null;
      renderGrid();
    });
  }

  // ── Build iframe URL ──
  function iframeUrl(widgetId) {
    let url = `/api/widget-preview/${encodeURIComponent(widgetId)}`;
    const params = new URLSearchParams();

    // Add mode parameter
    params.set('mode', previewMode);

    // Color params from preset (if ref selected, use matching preset)
    const preset = currentRef ? presets.find(p => p.source_ref === currentRef) : null;
    if (preset && preset.color_system) {
      const cs = preset.color_system;
      if (cs.brand_main) params.set('brand_main', cs.brand_main.replace('#', ''));
      if (cs.accent) params.set('accent', cs.accent.replace('#', ''));
    }

    return url + '?' + params.toString();
  }

  // ── New widget actions ──
  async function reviewWidget(widgetId) {
    await fetch(`/api/widget/${encodeURIComponent(widgetId)}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'reviewed' }),
    });
    await fetchAll();
    render();
  }

  async function deleteNewWidget(widgetId) {
    await fetch(`/api/widget/${encodeURIComponent(widgetId)}`, { method: 'DELETE' });
    await fetchAll();
    render();
  }

  async function bulkReviewAll() {
    await fetch('/api/widgets/bulk-review', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'review_all' }),
    });
    await fetchAll();
    render();
  }

  async function resolveDuplicate(keepId, deleteId) {
    await fetch('/api/widgets/resolve-duplicate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ keep: keepId, delete: deleteId }),
    });
    closeDupModal();
    await fetchAll();
    render();
  }

  async function keepBothWidgets(widgetA, widgetB) {
    await fetch('/api/widgets/keep-both', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ widget_a: widgetA, widget_b: widgetB }),
    });
    closeDupModal();
    await fetchAll();
    render();
  }

  async function deleteBothWidgets(widgetA, widgetB) {
    await fetch('/api/widgets/delete-both', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ widget_a: widgetA, widget_b: widgetB }),
    });
    closeDupModal();
    await fetchAll();
    render();
  }

  // ── Dup Compare Modal ──
  let currentDupPair = null; // { newWidget, existingWidget }

  function openDupModal(newW, existingW, score) {
    currentDupPair = { newWidget: newW, existingWidget: existingW };
    const scorePct = Math.round((score || 0) * 100);
    document.getElementById('dupModalScore').textContent = `유사도: ${scorePct}%`;

    const body = document.getElementById('dupModalBody');
    body.innerHTML = `
      <div class="dup-modal-side">
        <span class="dup-modal-side-label">기존 위젯 · ${existingW.source_ref || ''}</span>
        <div class="dup-modal-preview" id="dupPreviewLeft"></div>
      </div>
      <div class="dup-modal-side">
        <span class="dup-modal-side-label">새 위젯 · ${newW.source_ref || ''}</span>
        <div class="dup-modal-preview" id="dupPreviewRight"></div>
      </div>
    `;

    // Create iframes
    for (const [containerId, widgetId] of [['dupPreviewLeft', existingW.widget_id], ['dupPreviewRight', newW.widget_id]]) {
      const container = document.getElementById(containerId);
      const iframe = document.createElement('iframe');
      iframe.src = iframeUrl(widgetId);
      iframe.loading = 'lazy';
      iframe.scrolling = 'no';
      iframe.onload = () => fitCardIframe(iframe);
      container.appendChild(iframe);
    }

    // Actions
    const actions = document.getElementById('dupModalActions');
    actions.innerHTML = `
      <button class="btn-keep-one" id="dupKeepExisting">기존 유지</button>
      <button class="btn-keep-one" id="dupKeepNew">새 위젯 유지</button>
      <button class="btn-keep-both" id="dupKeepBoth">둘 다 유지</button>
      <button class="btn-delete-both" id="dupDeleteBoth">둘 다 삭제</button>
    `;

    document.getElementById('dupKeepExisting').addEventListener('click', () =>
      resolveDuplicate(existingW.widget_id, newW.widget_id));
    document.getElementById('dupKeepNew').addEventListener('click', () =>
      resolveDuplicate(newW.widget_id, existingW.widget_id));
    document.getElementById('dupKeepBoth').addEventListener('click', () =>
      keepBothWidgets(existingW.widget_id, newW.widget_id));
    document.getElementById('dupDeleteBoth').addEventListener('click', () =>
      deleteBothWidgets(existingW.widget_id, newW.widget_id));

    document.getElementById('dupModalOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeDupModal() {
    currentDupPair = null;
    document.getElementById('dupModalOverlay').classList.remove('open');
    document.getElementById('dupModalBody').innerHTML = '';
    document.getElementById('dupModalActions').innerHTML = '';
    document.body.style.overflow = '';
  }

  document.getElementById('dupModalClose').addEventListener('click', closeDupModal);
  document.getElementById('dupModalOverlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('dupModalOverlay')) closeDupModal();
  });

  // ── Unmapped section actions ──
  async function approveUnmapped(reportFile, suggestedId) {
    await fetch('/api/unmapped/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ report_file: reportFile, suggested_id: suggestedId }),
    });
    await fetchAll();
    // If no more unmapped sections, switch back to all view
    if (unmappedSections.length === 0) currentFilter = null;
    render();
  }

  let pendingReassign = null; // { report_file, suggested_id, suggested_category }

  function openReassignModal(reportFile, suggestedId, suggestedCategory) {
    pendingReassign = { report_file: reportFile, suggested_id: suggestedId, suggested_category: suggestedCategory };
    document.getElementById('reassignDesc').textContent =
      `"${suggestedId}"를 배정할 기존 섹션을 선택하세요:`;

    // Build category-grouped radio options
    let html = '';
    for (const catId of CATEGORY_ORDER) {
      const cat = taxonomy.categories[catId];
      const sections = taxonomy.sections.filter(s => s.category === catId);
      if (sections.length === 0) continue;
      const isRecommended = catId === suggestedCategory;
      html += `<div class="reassign-cat-header">${cat.name} (${catId})${isRecommended ? ' <span class="recommended">← 권장</span>' : ''}</div>`;
      html += `<div class="reassign-options">`;
      for (const s of sections) {
        html += `<label class="reassign-option">
          <input type="radio" name="reassign_to" value="${s.id}">
          ${s.id}
        </label>`;
      }
      html += `</div>`;
    }

    document.getElementById('reassignBody').innerHTML = html;
    document.getElementById('reassignSubmit').disabled = true;

    // Bind radio selection
    document.getElementById('reassignBody').querySelectorAll('.reassign-option').forEach(opt => {
      opt.addEventListener('click', () => {
        document.getElementById('reassignBody').querySelectorAll('.reassign-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        opt.querySelector('input').checked = true;
        document.getElementById('reassignSubmit').disabled = false;
      });
    });

    document.getElementById('reassignOverlay').classList.add('open');
  }

  function closeReassignModal() {
    pendingReassign = null;
    document.getElementById('reassignOverlay').classList.remove('open');
  }

  async function submitReassign() {
    if (!pendingReassign) return;
    const selected = document.querySelector('input[name="reassign_to"]:checked');
    if (!selected) return;

    await fetch('/api/unmapped/reject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        report_file: pendingReassign.report_file,
        suggested_id: pendingReassign.suggested_id,
        assign_to: selected.value,
      }),
    });

    closeReassignModal();
    await fetchAll();
    if (unmappedSections.length === 0) currentFilter = null;
    render();
  }

  document.getElementById('reassignClose').addEventListener('click', closeReassignModal);
  document.getElementById('reassignCancel').addEventListener('click', closeReassignModal);
  document.getElementById('reassignSubmit').addEventListener('click', submitReassign);
  document.getElementById('reassignOverlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('reassignOverlay')) closeReassignModal();
  });

  // ── Render unmapped sections grid ──
  function renderUnmappedGrid() {
    const grid = document.getElementById('grid');
    document.getElementById('filterCount').textContent = `${unmappedSections.length}개 미분류 섹션`;

    if (unmappedSections.length === 0) {
      grid.innerHTML = `<div class="empty-state"><div>미분류 섹션이 없습니다</div></div>`;
      return;
    }

    let html = '';
    for (const s of unmappedSections) {
      const confPct = Math.round((s.confidence || 0) * 100);
      html += `<div class="unmapped-card">
        <div class="unmapped-card-header">
          <span class="unmapped-card-header-id">${s.suggested_id}</span>
          <span class="unmapped-confidence">confidence ${confPct}%</span>
        </div>
        <div class="unmapped-card-body">
          <div class="unmapped-row">
            <span class="unmapped-label">카테고리</span>
            <span class="unmapped-value">${s.suggested_category || '-'}</span>
          </div>
          <div class="unmapped-row">
            <span class="unmapped-label">제안명</span>
            <span class="unmapped-value">${s.suggested_name || s.suggested_id}</span>
          </div>
          <div class="unmapped-row">
            <span class="unmapped-label">설명</span>
            <span class="unmapped-value">${s.description || '-'}</span>
          </div>
          ${s.suggested_keywords && s.suggested_keywords.length > 0 ? `<div class="unmapped-row">
            <span class="unmapped-label">키워드</span>
            <span class="unmapped-value"><span class="unmapped-tags">${s.suggested_keywords.map(k => `<span class="unmapped-tag">${k}</span>`).join('')}</span></span>
          </div>` : ''}
          ${s.suggested_visual_cues && s.suggested_visual_cues.length > 0 ? `<div class="unmapped-row">
            <span class="unmapped-label">시각단서</span>
            <span class="unmapped-value"><span class="unmapped-tags">${s.suggested_visual_cues.map(v => `<span class="unmapped-tag">${v}</span>`).join('')}</span></span>
          </div>` : ''}
          <div class="unmapped-row">
            <span class="unmapped-label">출처</span>
            <span class="unmapped-value">${s.reference || '-'}${s.position != null ? ` (#${s.position})` : ''}</span>
          </div>
        </div>
        <div class="unmapped-card-actions">
          <button class="btn-approve" data-report="${s.report_file}" data-id="${s.suggested_id}">새 섹션으로 승인</button>
          <button class="btn-reassign" data-report="${s.report_file}" data-id="${s.suggested_id}" data-cat="${s.suggested_category || 'features'}">기존 섹션에 배정</button>
        </div>
      </div>`;
    }

    grid.innerHTML = html;

    // Bind events
    grid.querySelectorAll('.btn-approve').forEach(btn => {
      btn.addEventListener('click', () => approveUnmapped(btn.dataset.report, btn.dataset.id));
    });
    grid.querySelectorAll('.btn-reassign').forEach(btn => {
      btn.addEventListener('click', () => openReassignModal(btn.dataset.report, btn.dataset.id, btn.dataset.cat));
    });
  }

  // ── Render new widgets grid ──
  function renderNewWidgetsGrid() {
    const grid = document.getElementById('grid');
    document.getElementById('filterCount').textContent = `${newWidgets.length}개 새 위젯`;

    if (newWidgets.length === 0) {
      grid.innerHTML = `<div class="empty-state"><div>새로 추가된 위젯이 없습니다</div></div>`;
      return;
    }

    const nonDup = newWidgets.filter(w => !w.duplicate_of);
    const dups = newWidgets.filter(w => w.duplicate_of);

    let html = '';

    // Bulk toolbar
    if (nonDup.length > 0) {
      html += `<div class="bulk-toolbar" style="grid-column:1/-1;">
        <span class="bulk-toolbar-text">새 위젯 ${newWidgets.length}개${dups.length > 0 ? ` (중복 후보 ${dups.length}개)` : ''}</span>
        <button class="btn-bulk" id="btnBulkReview">전체 보관 (${nonDup.length})</button>
      </div>`;
    }

    // Duplicate comparison cards (clickable → opens modal)
    for (const w of dups) {
      const dw = w.duplicate_widget;
      const score = Math.round((w.similarity_score || 0) * 100);
      html += `<div class="dup-card" data-dup-new="${w.widget_id}" data-dup-existing="${w.duplicate_of}" data-dup-score="${w.similarity_score || 0}" style="cursor:pointer;">
        <div class="dup-card-header">
          <span class="dup-card-header-title">중복 후보 — 클릭하여 비교</span>
          <span class="dup-similarity">유사도: ${score}%</span>
        </div>
        <div class="dup-card-body">
          <div class="dup-side">
            <span class="dup-side-label">기존 위젯 · ${dw ? (dw.source_ref || '') : ''}</span>
            <div class="dup-preview"><iframe src="${iframeUrl(w.duplicate_of)}" loading="lazy" scrolling="no"></iframe></div>
          </div>
          <div class="dup-side">
            <span class="dup-side-label">새 위젯 · ${w.source_ref || ''}</span>
            <div class="dup-preview"><iframe src="${iframeUrl(w.widget_id)}" loading="lazy" scrolling="no"></iframe></div>
          </div>
        </div>
      </div>`;
    }

    // Non-duplicate new widget cards
    for (const w of nonDup) {
      html += `
        <div class="card" data-id="${w.widget_id}">
          <div class="card-preview">
            <iframe src="${iframeUrl(w.widget_id)}" loading="lazy"></iframe>
          </div>
          <div class="card-meta">
            <div class="card-id">${w.widget_id} <span class="badge-new">NEW</span></div>
            <div class="card-badges">
              <span class="badge-pill badge-composition">${w.composition || 'stack'}</span>
              <span class="badge-pill badge-theme-${w.theme || 'dark'}">${w.theme || 'dark'}</span>
            </div>
            <div class="card-tags">${(w.style_tags || []).map(t => `<span class="tag-chip">${t}</span>`).join('')}</div>
            <div class="card-actions">
              <button class="btn-review" data-review="${w.widget_id}">보관</button>
              <button class="btn-card-delete" data-del="${w.widget_id}">삭제</button>
            </div>
          </div>
        </div>`;
    }

    grid.innerHTML = html;

    // Bind events
    const bulkBtn = document.getElementById('btnBulkReview');
    if (bulkBtn) bulkBtn.addEventListener('click', bulkReviewAll);

    // Fit all iframes in dup cards and non-dup cards
    grid.querySelectorAll('.dup-preview iframe, .card-preview iframe').forEach(iframe => {
      iframe.onload = () => fitCardIframe(iframe);
    });

    grid.querySelectorAll('.btn-review[data-review]').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); reviewWidget(btn.dataset.review); });
    });
    grid.querySelectorAll('.btn-card-delete[data-del]').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); deleteNewWidget(btn.dataset.del); });
    });
    // Dup card click -> dup compare modal
    grid.querySelectorAll('.dup-card[data-dup-new]').forEach(card => {
      card.addEventListener('click', () => {
        const newId = card.dataset.dupNew;
        const existId = card.dataset.dupExisting;
        const score = parseFloat(card.dataset.dupScore) || 0;
        const newW = dups.find(d => d.widget_id === newId);
        const existW = newW && newW.duplicate_widget ? newW.duplicate_widget : { widget_id: existId };
        if (newW) openDupModal(newW, existW, score);
      });
    });

    // Card click -> modal (non-dup cards)
    grid.querySelectorAll('.card[data-id]').forEach(card => {
      card.addEventListener('click', () => openModal(card.dataset.id));
    });
  }

  // ── Grid ──
  function renderGrid() {
    // Handle "새로 추가" tab
    if (currentFilter === '__new__') {
      renderNewWidgetsGrid();
      return;
    }

    // Handle "미분류 섹션" tab
    if (currentFilter === '__unmapped__') {
      renderUnmappedGrid();
      return;
    }

    const grid = document.getElementById('grid');
    let filtered = currentFilter
      ? allWidgets.filter(w => w.taxonomy_id === currentFilter)
      : allWidgets;
    if (currentRef) filtered = filtered.filter(w => w.source_ref === currentRef);

    document.getElementById('filterCount').textContent = `${filtered.length}개 위젯`;

    if (filtered.length === 0) {
      grid.innerHTML = `<div class="empty-state"><div>이 카테고리에 위젯이 없습니다</div></div>`;
      return;
    }

    // Check which widget IDs are "new"
    const newIdSet = new Set(newWidgets.map(w => w.widget_id));

    grid.innerHTML = filtered.map(w => `
      <div class="card" data-id="${w.widget_id}">
        <div class="card-preview">
          <iframe src="${iframeUrl(w.widget_id)}" loading="lazy" scrolling="no"></iframe>
        </div>
      </div>
    `).join('');

    // Fit iframes & bind card click
    grid.querySelectorAll('.card').forEach(card => {
      const iframe = card.querySelector('iframe');
      if (iframe) iframe.onload = () => fitCardIframe(iframe);
      card.addEventListener('click', () => openModal(card.dataset.id));
    });
  }

  // ── View toggle ──
  function setupViewToggle() {
    const btnGrid = document.getElementById('btnGrid');
    const btnList = document.getElementById('btnList');
    const grid = document.getElementById('grid');

    btnGrid.addEventListener('click', () => {
      viewMode = 'grid';
      btnGrid.classList.add('active');
      btnList.classList.remove('active');
      grid.classList.remove('list-view');
    });
    btnList.addEventListener('click', () => {
      viewMode = 'list';
      btnList.classList.add('active');
      btnGrid.classList.remove('active');
      grid.classList.add('list-view');
    });
  }

  // ── Demo/Raw mode toggle ──
  function setupModeToggle() {
    const btnDemo = document.getElementById('btnDemo');
    const btnRaw = document.getElementById('btnRaw');

    btnDemo.addEventListener('click', () => {
      if (previewMode === 'demo') return;
      previewMode = 'demo';
      btnDemo.classList.add('active');
      btnRaw.classList.remove('active');
      renderGrid();
      // Update modal iframe if open
      refreshModalPreview();
    });

    btnRaw.addEventListener('click', () => {
      if (previewMode === 'raw') return;
      previewMode = 'raw';
      btnRaw.classList.add('active');
      btnDemo.classList.remove('active');
      renderGrid();
      // Update modal iframe if open
      refreshModalPreview();
    });
  }

  // ── Refresh modal preview when mode changes ──
  let currentModalWidgetId = null;

  function fitCardIframe(iframe) {
    try {
      const contentH = iframe.contentDocument.documentElement.scrollHeight;
      const container = iframe.parentElement;
      const cardW = container.clientWidth;
      const cardH = container.clientHeight;
      const scale = Math.min(cardW / 860, cardH / contentH);
      iframe.style.height = contentH + 'px';
      iframe.style.transform = `scale(${scale})`;
    } catch (_) {
      iframe.style.height = '600px';
      iframe.style.transform = 'scale(0.38)';
    }
  }

  function fitIframe(iframe, container) {
    try {
      const contentH = iframe.contentDocument.documentElement.scrollHeight;
      iframe.style.height = contentH + 'px';
      iframe.style.marginBottom = -(contentH * 0.5) + 'px';
    } catch (_) {
      iframe.style.height = '600px';
      iframe.style.marginBottom = '-300px';
    }
  }

  function refreshModalPreview() {
    // Single widget modal
    if (currentModalWidgetId) {
      const previewEl = document.getElementById('modalPreview');
      const iframe = previewEl.querySelector('iframe');
      if (iframe) {
        iframe.src = iframeUrl(currentModalWidgetId);
        iframe.onload = () => fitIframe(iframe, previewEl);
      }
    }
    // Dup compare modal
    if (currentDupPair) {
      const pairs = [
        ['dupPreviewLeft', currentDupPair.existingWidget.widget_id],
        ['dupPreviewRight', currentDupPair.newWidget.widget_id],
      ];
      for (const [containerId, widgetId] of pairs) {
        const container = document.getElementById(containerId);
        if (!container) continue;
        const iframe = container.querySelector('iframe');
        if (iframe) {
          iframe.src = iframeUrl(widgetId);
          iframe.onload = () => {
            try {
              const contentH = iframe.contentDocument.documentElement.scrollHeight;
              iframe.style.height = contentH + 'px';
              const containerW = container.clientWidth;
              const scale = Math.min(containerW / 860, 1);
              iframe.style.transform = 'scale(' + scale + ')';
              container.style.height = Math.ceil(contentH * scale) + 'px';
            } catch (_) {}
          };
        }
      }
    }
  }

  // ── Copy to clipboard ──
  function copyToClipboard(text, buttonEl) {
    navigator.clipboard.writeText(text).then(() => {
      buttonEl.classList.add('copied');
      const original = buttonEl.textContent;
      buttonEl.textContent = buttonEl.classList.contains('btn-action') ? '복사됨!' : '✓';
      setTimeout(() => {
        buttonEl.classList.remove('copied');
        buttonEl.textContent = original;
      }, 1500);
    });
  }

  // ── Delete widget ──
  let pendingDeleteId = null;

  function showDeleteConfirm(widgetId) {
    pendingDeleteId = widgetId;
    document.getElementById('confirmMessage').textContent = `"${widgetId}" 위젯을 삭제하시겠습니까?\n파일과 레지스트리에서 모두 제거됩니다.`;
    document.getElementById('confirmOverlay').classList.add('open');
  }

  function hideDeleteConfirm() {
    pendingDeleteId = null;
    document.getElementById('confirmOverlay').classList.remove('open');
  }

  async function executeDelete() {
    if (!pendingDeleteId) return;
    const widgetId = pendingDeleteId;
    hideDeleteConfirm();

    try {
      const resp = await fetch(`/api/widget/${encodeURIComponent(widgetId)}`, { method: 'DELETE' });
      if (!resp.ok) {
        const msg = await resp.text();
        alert(`삭제 실패: ${msg}`);
        return;
      }

      // Refresh data and UI
      await fetchAll();
      closeModal();
      render();
    } catch (err) {
      alert(`삭제 중 오류: ${err.message}`);
    }
  }

  document.getElementById('confirmCancel').addEventListener('click', hideDeleteConfirm);
  document.getElementById('confirmDelete').addEventListener('click', executeDelete);
  document.getElementById('confirmOverlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('confirmOverlay')) hideDeleteConfirm();
  });

  // ── Modal ──
  function openModal(widgetId) {
    const w = allWidgets.find(x => x.widget_id === widgetId);
    if (!w) return;

    currentModalWidgetId = widgetId;
    const filePath = `widgets/${w.file}`;

    document.getElementById('modalTitle').textContent = w.widget_id;
    const previewEl = document.getElementById('modalPreview');
    previewEl.innerHTML = '';
    const iframe = document.createElement('iframe');
    iframe.src = iframeUrl(widgetId);
    iframe.scrolling = 'no';
    iframe.onload = () => fitIframe(iframe, previewEl);
    previewEl.appendChild(iframe);

    const info = document.getElementById('modalInfo');
    info.innerHTML = `
      <h4>Widget ID</h4>
      <p class="meta-val">${w.widget_id}</p>
      <h4>Taxonomy</h4>
      <p class="meta-val">${w.taxonomy_id} (${w.category})</p>
      <h4>File</h4>
      <div class="file-path-row">
        <p class="meta-val">${filePath}</p>
        <button class="btn-copy-sm" id="btnCopyPath" title="경로 복사">&#128203;</button>
      </div>
      <h4>Composition</h4>
      <p class="meta-val">${w.composition || 'stack'}</p>
      <h4>Theme</h4>
      <p class="meta-val">${w.theme || 'dark'}</p>
      ${w.variant ? `<h4>Variant</h4><p class="meta-val">${w.variant}</p>` : ''}
      <h4>Source Ref</h4>
      <p class="meta-val">${w.source_ref || '-'}</p>
      <h4>Style Tags</h4>
      <div class="meta-tags">${(w.style_tags || []).map(t => `<span class="tag-chip">${t}</span>`).join('')}</div>
      <div class="modal-actions">
        <button class="btn-action" id="btnCopyFilePath">&#128203; 파일 경로 복사</button>
        <button class="btn-action btn-delete" id="btnDeleteWidget">&#128465; 위젯 삭제</button>
      </div>
    `;

    // Bind action buttons
    document.getElementById('btnCopyPath').addEventListener('click', (e) => {
      e.stopPropagation();
      copyToClipboard(filePath, e.currentTarget);
    });
    document.getElementById('btnCopyFilePath').addEventListener('click', () => {
      copyToClipboard(filePath, document.getElementById('btnCopyFilePath'));
    });
    document.getElementById('btnDeleteWidget').addEventListener('click', () => {
      showDeleteConfirm(widgetId);
    });

    document.getElementById('modalOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    currentModalWidgetId = null;
    document.getElementById('modalOverlay').classList.remove('open');
    document.getElementById('modalPreview').innerHTML = '';
    document.body.style.overflow = '';
  }

  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (document.getElementById('reassignOverlay').classList.contains('open')) {
        closeReassignModal();
      } else if (document.getElementById('confirmOverlay').classList.contains('open')) {
        hideDeleteConfirm();
      } else if (document.getElementById('dupModalOverlay').classList.contains('open')) {
        closeDupModal();
      } else {
        closeModal();
      }
    }
  });

  // ── Render ──
  function render() {
    buildSidebar();
    renderGrid();
  }

  // ── Init ──
  async function init() {
    await fetchAll();
    buildRefSelect();
    setupViewToggle();
    setupModeToggle();
    render();
  }

  init();
})();
</script>
</body>
</html>
